{"version":3,"file":"svgraph.js","sources":["../src/label.ts","../src/svg.ts","../src/svgraph.ts"],"sourcesContent":["export interface Label {\n\tget text(): string\n\tgetPos(max: number): number\n}\n\nexport class NumberLabel implements Label {\n\tconstructor(public value: number) { }\n\n\tget text() { return this.value.toString() }\n\n\tgetPos(max: number) { return this.value / max }\n}\n\n// TODO: date labels etc\n","const ns = \"http://www.w3.org/2000/svg\"\n\nexport function element(name: string, attrs: { [key: string]: any }, children: Node[] = []): SVGElement {\n\tconst elem = document.createElementNS(ns, name)\n\tfor (const key in attrs) {\n\t\tif (attrs[key] !== undefined) elem.setAttribute(key, attrs[key])\n\t}\n\tfor (const child of children ?? []) elem.appendChild(child)\n\treturn elem\n}\n\ntype stringable = string | number | boolean\n\ntype DefaultAttrs = {\n\tid?: string,\n\tclass?: string\n\ttransform?: string,\n\tfill?: string\n\tstroke?: string\n\t\"stroke-width\"?: string\n}\n\nexport const svg = (attrs: { width: string, height: string, viewBox?: string, preserveAspectRatio?: string, overflow?: string } & DefaultAttrs, ...children: Node[]) =>\n\telement(\"svg\", { ...attrs, xmlns: ns }, children)\n\nexport const g = (attrs: DefaultAttrs = {}, ...children: Node[]) => element(\"g\", attrs, children)\n\nexport const line = (attrs: { from: [stringable, stringable], to: [stringable, stringable] } & DefaultAttrs, ...children: Node[]) =>\n\telement(\"line\", { ...attrs, x1: attrs.from[0], y1: attrs.from[1], x2: attrs.to[0], y2: attrs.to[1], from: undefined, to: undefined }, children)\n\nexport const polyline = (attrs: { points: [number, number][] } & DefaultAttrs, ...children: Node[]) =>\n\telement(\"polyline\", { ...attrs, points: attrs.points.map(([x, y]) => `${x},${y}`).join(\" \") }, children)\n\nexport const rect = (attrs: { x?: stringable, y?: stringable, width: stringable, height: stringable, rx?: stringable, ry?: stringable } & DefaultAttrs, ...children: Node[]) =>\n\telement(\"rect\", attrs, children)\n\nexport const text = (attrs: { x: stringable, y: stringable, dx?: stringable, dy?: stringable, rotate?: number[], lengthAdjust?: string, textLength?: stringable, \"text-anchor\"?: \"start\" | \"middle\" | \"end\" } & DefaultAttrs, ...children: Node[]) =>\n\telement(\"text\", attrs, children)\n","import { Label, NumberLabel } from \"./label\"\nimport { defs, g, line, pattern, polyline, rect, svg, text } from \"./svg\"\n\nexport { Label, NumberLabel } from \"./label\"\n\nexport type Config = {\n\tdata: { [category: string]: number[] }\n\txLabels?: Label[]\n\tyLabels?: Label[]\n\tstyle?: Style\n}\n\nexport type Style = {\n\txAxisSize?: number\n\tyAxisSize?: number\n}\n\nexport default class SVGraph {\n\telem: SVGElement\n\n\tdata: { name: string, values: number[] }[]\n\txLabels: Label[]\n\tyLabels: Label[]\n\tstyle: Style\n\n\tmaxX: number\n\tmaxY: number\n\tprivate resizeObserver: ResizeObserver\n\n\tconstructor(config: Config) {\n\t\tthis.elem = svg({ width: \"100%\", height: \"100%\", overflow: \"visible\" })\n\t\tthis.update(config, false)\n\n\t\tthis.resizeObserver = new ResizeObserver((entries) => {\n\t\t\tthis.draw(entries[0].contentBoxSize[0].inlineSize, entries[0].contentBoxSize[0].blockSize)\n\t\t})\n\t\tthis.resizeObserver.observe(this.elem, { box: \"content-box\" })\n\t}\n\n\tupdate({ data, xLabels, yLabels, style }: Config, redraw = true) {\n\t\tthis.data = Object.entries(data).sort((a, b) => b[1].max() - a[1].max()).map(([name, values]) => ({ name, values }))\n\n\t\tthis.maxX = this.data.map(({ values }) => values.length - 1).max()\n\t\tthis.maxY = this.data[0].values.max()\n\n\t\tthis.xLabels = xLabels ?? new Set(this.data.flatMap(({ values }) => values.keys().toArray())).values().toArray().sort().map((i) => new NumberLabel(i))\n\t\tthis.yLabels = yLabels ?? [new NumberLabel(0), new NumberLabel(this.maxY)]\n\n\t\tthis.style = {\n\t\t\txAxisSize: style?.xAxisSize ?? 30,\n\t\t\tyAxisSize: style?.yAxisSize ?? 30\n\t\t}\n\n\t\tif (redraw) this.draw(this.elem.clientWidth, this.elem.clientHeight)\n\t}\n\n\tdraw(width: number, height: number) {\n\t\tthis.elem.innerHTML = \"\"\n\n\t\tthis.elem.appendChild(this.grid(this.style.yAxisSize, 0, width - this.style.yAxisSize, height - this.style.xAxisSize))\n\t\tthis.elem.appendChild(this.axes(0, 0, width, height))\n\t\tthis.elem.appendChild(this.lines(this.style.yAxisSize, 0, width - this.style.yAxisSize, height - this.style.xAxisSize))\n\t}\n\n\tprivate axes(x: number, y: number, width: number, height: number): SVGElement {\n\t\treturn g({ class: \"axes\", transform: `translate(${x}, ${y})` },\n\t\t\tthis.xAxis(this.style.yAxisSize, height - this.style.xAxisSize, width - this.style.yAxisSize, this.style.xAxisSize),\n\t\t\tthis.yAxis(0, 0, this.style.yAxisSize, height - this.style.xAxisSize)\n\t\t)\n\t}\n\n\tprivate xAxis = (x: number, y: number, width: number, height: number): SVGElement =>\n\t\tg({ class: \"xaxis\" },\n\t\t\tline({ from: [x, y], to: [x + width, y], stroke: \"black\" }),\n\t\t\t...this.xLabels.map(step => text({\n\t\t\t\tx: x + step.getPos(this.maxX) * width,\n\t\t\t\ty: y + 20,\n\t\t\t\t\"text-anchor\": \"middle\"\n\t\t\t}, new Text(step.text)))\n\t\t)\n\n\tprivate yAxis = (x: number, y: number, width: number, height: number): SVGElement =>\n\t\tg({ class: \"yaxis\" },\n\t\t\tline({ from: [x + width, y], to: [x + width, y + height], stroke: \"black\" }),\n\t\t\t...this.yLabels.map(step => text({\n\t\t\t\tx: x + width - 10,\n\t\t\t\ty: y + (1 - step.getPos(this.maxY)) * height + 5,\n\t\t\t\t\"text-anchor\": \"end\"\n\t\t\t}, new Text(step.text)))\n\t\t)\n\n\tprivate grid = (x: number, y: number, width: number, height: number): SVGElement =>\n\t\tg({ class: \"grid\", transform: `translate(${x}, ${y})` },\n\t\t\t...this.xLabels.map(step => line({\n\t\t\t\tfrom: [step.getPos(this.maxX) * width, 0],\n\t\t\t\tto: [step.getPos(this.maxX) * width, height],\n\t\t\t\tstroke: \"#0004\"\n\t\t\t})),\n\t\t\t...this.yLabels.map(step => line({\n\t\t\t\tfrom: [0, (1 - step.getPos(this.maxY)) * height],\n\t\t\t\tto: [width, (1 - step.getPos(this.maxY)) * height],\n\t\t\t\tstroke: \"#0004\"\n\t\t\t})),\n\t\t)\n\n\tprivate lines(x: number, y: number, width: number, height: number): SVGElement {\n\t\tconst elem = g({ class: \"lines\", transform: `translate(${x}, ${y})`, \"stroke-width\": \"2\" })\n\t\tfor (const { name, values } of this.data) {\n\t\t\tconst points = values.map((y, x) => [x * width / this.maxX, (1 - y / this.maxY) * height] as [number, number])\n\t\t\telem.appendChild(polyline({ points, fill: \"none\", stroke: \"black\" }))\n\t\t}\n\t\treturn elem\n\t}\n}\n\ndeclare global {\n\tinterface Array<T> {\n\t\tmax(): number\n\t\tmin(): number\n\t}\n}\n\nArray.prototype.max = function () { return this.reduce((a, b) => Math.max(a, b), 0) }\nArray.prototype.min = function () { return this.reduce((a, b) => Math.min(a, b), 0) }\n"],"names":["NumberLabel","value","constructor","this","text","toString","getPos","max","ns","element","name","attrs","children","elem","document","createElementNS","key","undefined","setAttribute","child","appendChild","g","line","x1","from","y1","x2","to","y2","polyline","points","map","x","y","join","SVGraph","data","xLabels","yLabels","style","maxX","maxY","resizeObserver","config","xmlns","svg","width","height","overflow","update","ResizeObserver","entries","draw","contentBoxSize","inlineSize","blockSize","observe","box","redraw","Object","sort","a","b","values","length","Set","flatMap","keys","toArray","i","xAxisSize","yAxisSize","clientWidth","clientHeight","innerHTML","grid","axes","lines","class","transform","xAxis","yAxis","stroke","step","Text","fill","Array","prototype","reduce","Math","min"],"mappings":"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"}